EXECUTABLE=mcp-server-prtg
BUILD_DIR=build
WINDOWS=$(BUILD_DIR)/$(EXECUTABLE)_windows_amd64.exe
LINUX_AMD64=$(BUILD_DIR)/$(EXECUTABLE)_linux_amd64
LINUX_ARM64=$(BUILD_DIR)/$(EXECUTABLE)_linux_arm64
DARWIN_AMD64=$(BUILD_DIR)/$(EXECUTABLE)_darwin_amd64
DARWIN_ARM64=$(BUILD_DIR)/$(EXECUTABLE)_darwin_arm64
VERSION=$(shell git describe --tags --always --abbrev=0 2>/dev/null || echo "v1.0.0")
COMMIT_HASH=$(shell git describe --tags --always --long --dirty 2>/dev/null || echo "unknown")

# Package to set version variable (use 'main' for main package)
PACKAGE=main

BUILD_TIME=$(shell date +%FT%T%z)
GO_VERSION=$(shell go version | cut -d' ' -f3)
COVERAGE_FILE=coverage.out

# Couleurs pour l'affichage
GREEN=\033[0;32m
YELLOW=\033[0;33m
RED=\033[0;31m
BLUE=\033[0;34m
NC=\033[0m # No Color

# LDFLAGS enrichis avec informations de build
LDFLAGS=-s -w \
	-X '${PACKAGE}.Version=$(VERSION)' \
	-X '${PACKAGE}.CommitHash=$(COMMIT_HASH)' \
	-X '${PACKAGE}.BuildTime=$(BUILD_TIME)' \
	-X '${PACKAGE}.GoVersion=$(GO_VERSION)'

# ========================================
# VERSION MANAGEMENT
# ========================================

version-info: ## Affiche les informations de version
	@echo "$(BLUE)‚ÑπÔ∏è  Version information:$(NC)"
	@echo "  Version:    $(VERSION)"
	@echo "  Commit:     $(COMMIT_HASH)"
	@echo "  Build time: $(BUILD_TIME)"
	@echo "  Go version: $(GO_VERSION)"

check-version: ## V√©rifie que la version est d√©finie
	@if [ "$(VERSION)" = "" ]; then \
		echo "$(RED)‚ùå ERROR: No version tag found$(NC)" >&2; \
		exit 1; \
	fi
	@echo "$(GREEN)‚úÖ Version: $(VERSION)$(NC)"

# Gestion manuelle des versions (pour d√©veloppement et RC)
bump-version: ## Cr√©er une nouvelle version tag
	@current_version=$$(git tag -l | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sort -V | tail -n1 | sed 's/v//'); \
	if [ -z "$$current_version" ]; then \
		current_version="1.0.0"; \
	fi; \
	echo "$(YELLOW)Current version: v$$current_version$(NC)"; \
	read -p "Enter new version [$$current_version]: " new_version; \
	: "$${new_version:=$$current_version}"; \
	if [[ ! "$$new_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$$ ]]; then \
		echo "$(RED)‚ùå Invalid version format. Use X.Y.Z or X.Y.Z-rcN$(NC)"; \
		exit 1; \
	fi; \
	echo "$(GREEN)Creating new version: v$$new_version$(NC)"; \
	git tag -a "v$$new_version" -m "Version $$new_version"; \
	echo "$(GREEN)‚úÖ Tag created. Push with: git push origin v$$new_version$(NC)"

# Supprimer un tag de version (utile pour corrections)
delete-version: ## Supprimer un tag de version
	@echo "$(YELLOW)Current tags:$(NC)"; \
	git tag -l | grep -E '^v[0-9]+'; \
	read -p "Enter tag to delete (without v): " version_to_delete; \
	git tag -d "v$$version_to_delete"; \
	echo "$(GREEN)‚úÖ Tag deleted locally. Push deletion with: git push origin :refs/tags/v$$version_to_delete$(NC)"

# ========================================
# BUILD TARGETS
# ========================================

# Create build directory
create-build-dir:
	@mkdir -p $(BUILD_DIR)

# Build par d√©faut (OS courant)
build: create-build-dir ## Build pour l'OS courant
	@echo "$(GREEN)üî® Building $(EXECUTABLE) for current OS...$(NC)"
	CGO_ENABLED=0 go build -trimpath -ldflags="$(LDFLAGS)" -o $(BUILD_DIR)/$(EXECUTABLE) ./cmd/server
	@echo "$(GREEN)‚úÖ Build complete: $(BUILD_DIR)/$(EXECUTABLE)$(NC)"
	@echo "$(BLUE)Version: $(VERSION) - Commit: $(COMMIT_HASH)$(NC)"

# Build toutes les plateformes
build-all: create-build-dir build-windows build-linux build-darwin ## Build pour toutes les plateformes
	@echo "$(GREEN)‚úÖ All builds complete!$(NC)"
	@ls -lh $(BUILD_DIR)

build-windows: create-build-dir ## Build pour Windows
	@echo "$(GREEN)ü™ü Building for Windows...$(NC)"
	CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -trimpath -ldflags="$(LDFLAGS)" -o $(WINDOWS) ./cmd/server
	@echo "$(GREEN)‚úÖ Windows build complete$(NC)"

build-linux: create-build-dir ## Build pour Linux (amd64 + arm64)
	@echo "$(GREEN)üêß Building for Linux amd64...$(NC)"
	CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="$(LDFLAGS)" -o $(LINUX_AMD64) ./cmd/server
	@echo "$(GREEN)üêß Building for Linux arm64...$(NC)"
	CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -ldflags="$(LDFLAGS)" -o $(LINUX_ARM64) ./cmd/server
	@echo "$(GREEN)‚úÖ Linux builds complete$(NC)"

build-darwin: create-build-dir ## Build pour macOS (amd64 + arm64)
	@echo "$(GREEN)üçé Building for macOS amd64...$(NC)"
	CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -trimpath -ldflags="$(LDFLAGS)" -o $(DARWIN_AMD64) ./cmd/server
	@echo "$(GREEN)üçé Building for macOS arm64...$(NC)"
	CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -trimpath -ldflags="$(LDFLAGS)" -o $(DARWIN_ARM64) ./cmd/server
	@echo "$(GREEN)‚úÖ macOS builds complete$(NC)"

# ========================================
# PACKAGING TARGETS
# ========================================

package: build-all ## Cr√©er des archives ZIP pour toutes les plateformes
	@echo "$(GREEN)üì¶ Creating ZIP packages...$(NC)"
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_windows_amd64.zip $(EXECUTABLE)_windows_amd64.exe
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_linux_amd64.zip $(EXECUTABLE)_linux_amd64
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_linux_arm64.zip $(EXECUTABLE)_linux_arm64
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_darwin_amd64.zip $(EXECUTABLE)_darwin_amd64
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_darwin_arm64.zip $(EXECUTABLE)_darwin_arm64
	@echo "$(GREEN)‚úÖ ZIP packages created in $(BUILD_DIR)/$(NC)"
	@ls -lh $(BUILD_DIR)/*.zip

package-windows: build-windows ## Cr√©er archive ZIP pour Windows
	@echo "$(GREEN)üì¶ Creating Windows ZIP package...$(NC)"
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_windows_amd64.zip $(EXECUTABLE)_windows_amd64.exe
	@echo "$(GREEN)‚úÖ Windows ZIP package created$(NC)"

package-linux: build-linux ## Cr√©er archives ZIP pour Linux
	@echo "$(GREEN)üì¶ Creating Linux ZIP packages...$(NC)"
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_linux_amd64.zip $(EXECUTABLE)_linux_amd64
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_linux_arm64.zip $(EXECUTABLE)_linux_arm64
	@echo "$(GREEN)‚úÖ Linux ZIP packages created$(NC)"

package-darwin: build-darwin ## Cr√©er archives ZIP pour macOS
	@echo "$(GREEN)üì¶ Creating macOS ZIP packages...$(NC)"
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_darwin_amd64.zip $(EXECUTABLE)_darwin_amd64
	@cd $(BUILD_DIR) && zip -9 $(EXECUTABLE)_darwin_arm64.zip $(EXECUTABLE)_darwin_arm64
	@echo "$(GREEN)‚úÖ macOS ZIP packages created$(NC)"

# ========================================
# DEVELOPMENT TARGETS
# ========================================

run: ## Ex√©cuter le serveur en mode d√©veloppement
	@echo "$(BLUE)üöÄ Running MCP server...$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  Assurez-vous que PRTG_DB_PASSWORD est d√©fini$(NC)"
	@go run ./cmd/server

# Ex√©cuter avec configuration de test
run-dev: ## Ex√©cuter avec variables d'environnement de dev
	@echo "$(BLUE)üöÄ Running MCP server (dev mode)...$(NC)"
	LOG_LEVEL=debug go run ./cmd/server

# ========================================
# TESTING & QUALITY TARGETS
# ========================================

test: ## Ex√©cuter les tests
	@echo "$(GREEN)üß™ Running tests...$(NC)"
	@go test ./... -v
	@echo "$(GREEN)‚úÖ Tests passed$(NC)"

test-race: ## Tests avec d√©tection de race conditions
	@echo "$(GREEN)üèÉ‚Äç‚ôÇÔ∏è Tests avec d√©tection de race conditions...$(NC)"
	@go test -race -v ./...
	@echo "$(GREEN)‚úÖ Tests race termin√©s$(NC)"

benchmark: ## Tests de performance
	@echo "$(GREEN)‚ö° Running benchmarks...$(NC)"
	@go test -bench=. -benchmem ./...
	@echo "$(GREEN)‚úÖ Benchmarks termin√©s$(NC)"

coverage: ## Rapport de couverture de tests
	@echo "$(GREEN)üìä G√©n√©ration du rapport de couverture...$(NC)"
	@go test -coverprofile=$(COVERAGE_FILE) ./...
	@go tool cover -html=$(COVERAGE_FILE) -o coverage.html
	@echo "$(GREEN)‚úÖ Rapport g√©n√©r√©: coverage.html$(NC)"
	@echo "$(YELLOW)üìà R√©sum√© de la couverture:$(NC)"
	@go tool cover -func=$(COVERAGE_FILE) | tail -1

lint: ## Analyse de qualit√© du code (golangci-lint)
	@echo "$(GREEN)üîç Analyse de qualit√© du code...$(NC)"
	@command -v golangci-lint >/dev/null 2>&1 || { \
		echo "$(RED)‚ùå golangci-lint non install√©. Ex√©cutez 'make install-tools'$(NC)"; \
		exit 1; \
	}
	@golangci-lint run --timeout=5m
	@echo "$(GREEN)‚úÖ Analyse lint termin√©e$(NC)"

lint-fix: ## Corrige automatiquement les probl√®mes de style
	@echo "$(GREEN)üîß Correction automatique des probl√®mes...$(NC)"
	@go fmt ./...
	@go mod tidy
	@command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --fix --timeout=5m || echo "$(YELLOW)‚ö†Ô∏è  golangci-lint non disponible$(NC)"
	@echo "$(GREEN)‚úÖ Corrections appliqu√©es$(NC)"

fmt: ## Formater le code
	@echo "$(GREEN)üé® Formatting code...$(NC)"
	@go fmt ./...
	@echo "$(GREEN)‚úÖ Code formatted$(NC)"

vet: ## Ex√©cuter go vet
	@echo "$(GREEN)üîç Running go vet...$(NC)"
	@go vet ./...
	@echo "$(GREEN)‚úÖ go vet passed$(NC)"

security: ## Audit de s√©curit√© (govulncheck + gosec)
	@echo "$(GREEN)üõ°Ô∏è  Audit de s√©curit√©...$(NC)"
	@command -v govulncheck >/dev/null 2>&1 || { \
		echo "$(RED)‚ùå govulncheck non install√©. Ex√©cutez 'make install-tools'$(NC)"; \
		exit 1; \
	}
	@if command -v gosec >/dev/null 2>&1; then \
		echo "$(YELLOW)üîí Analyse gosec...$(NC)"; \
		gosec -quiet ./...; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  gosec non install√© - ignor√©$(NC)"; \
	fi
	@echo "$(YELLOW)üîç V√©rification des vuln√©rabilit√©s...$(NC)"
	@govulncheck ./...
	@echo "$(GREEN)‚úÖ Audit de s√©curit√© termin√©$(NC)"

install-tools: ## Installer tous les outils de d√©veloppement
	@echo "$(GREEN)üì¶ Installation des outils de d√©veloppement...$(NC)"
	@echo "$(YELLOW)Installing golangci-lint...$(NC)"
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "$(YELLOW)Installing govulncheck...$(NC)"
	@go install golang.org/x/vuln/cmd/govulncheck@latest
	@echo "$(YELLOW)Installing staticcheck...$(NC)"
	@go install honnef.co/go/tools/cmd/staticcheck@latest
	@echo "$(YELLOW)Note: Pour gosec, installez manuellement: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest$(NC)"
	@echo "$(GREEN)‚úÖ Outils de base install√©s$(NC)"

# ========================================
# WORKFLOW TARGETS
# ========================================

pre-commit: fmt vet lint-fix test ## V√©rifications avant commit
	@echo "$(GREEN)‚úÖ Pr√™t pour le commit !$(NC)"

quality-check: fmt vet lint test security ## V√©rification compl√®te de qualit√©
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)üéâ CONTR√îLES DE QUALIT√â R√âUSSIS ! üéâ$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)‚úÖ Formatage: OK$(NC)"
	@echo "$(GREEN)‚úÖ go vet: OK$(NC)"
	@echo "$(GREEN)‚úÖ Qualit√© du code (lint): OK$(NC)"
	@echo "$(GREEN)‚úÖ Tests: OK$(NC)"
	@echo "$(GREEN)‚úÖ S√©curit√©: OK$(NC)"
	@echo ""

release: quality-check build-all package ## Pr√©parer une release compl√®te
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)üöÄ RELEASE PR√äTE ! üöÄ$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BLUE)Version: $(VERSION)$(NC)"
	@echo "$(BLUE)Commit:  $(COMMIT_HASH)$(NC)"
	@echo "$(BLUE)Binaires et packages dans: $(BUILD_DIR)/$(NC)"
	@ls -lh $(BUILD_DIR)
	@echo ""
	@echo "$(YELLOW)Pour publier:$(NC)"
	@echo "  1. git push origin $(VERSION)"
	@echo "  2. Cr√©er une release GitHub avec les ZIPs"
	@echo ""

# ========================================
# UTILITY TARGETS
# ========================================

deps: ## T√©l√©charger les d√©pendances
	@echo "$(GREEN)üì¶ Downloading dependencies...$(NC)"
	@go mod download
	@go mod tidy
	@echo "$(GREEN)‚úÖ Dependencies updated$(NC)"

verify: fmt vet lint test ## V√©rifier le code (fmt, vet, lint, test)
	@echo "$(GREEN)‚úÖ All verifications passed!$(NC)"

clean: ## Nettoyer les artefacts de build
	@echo "$(YELLOW)üßπ Cleaning...$(NC)"
	@rm -rf $(BUILD_DIR)
	@rm -f $(COVERAGE_FILE)
	@rm -f coverage.html
	@go clean -testcache
	@echo "$(GREEN)‚úÖ Clean complete$(NC)"

install: build ## Installer le binaire dans $GOPATH/bin
	@echo "$(GREEN)üì• Installing $(EXECUTABLE)...$(NC)"
	@mkdir -p $(GOPATH)/bin
	@cp $(BUILD_DIR)/$(EXECUTABLE) $(GOPATH)/bin/
	@echo "$(GREEN)‚úÖ Installed to $(GOPATH)/bin/$(EXECUTABLE)$(NC)"

help: ## Afficher cette aide
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)         MCP Server PRTG - Commandes disponibles$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(YELLOW)üî® Build & Deploy:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(build|package|install|run|create)' | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)üß™ Tests & Qualit√©:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(test|lint|security|coverage|benchmark|fmt|vet)' | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)üîÑ Workflows:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(pre-commit|quality-check|release|verify)' | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)üè∑Ô∏è  Version:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(version|bump|delete)' | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)üõ†Ô∏è  Outils:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E '(install-tools|deps|clean|help)' | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

.PHONY: all build build-all build-windows build-linux build-darwin package package-windows package-linux package-darwin \
	run run-dev test test-race benchmark coverage lint lint-fix fmt vet security install-tools \
	pre-commit quality-check release verify deps clean install create-build-dir \
	version-info check-version bump-version delete-version help

.DEFAULT_GOAL := help
